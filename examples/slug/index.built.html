<!doctype html>
<head>
  <link href="https://static.contentful.com/app/main-62e0abc7.css" media="all" rel="stylesheet" type="text/css">
  <link href="https://static.contentful.com/app/vendor-976872d7.css" media="all" rel="stylesheet" type="text/css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/3.0.2/es6-promise.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/speakingurl/7.0.0/speakingurl.min.js"></script>
</head>
<div class="widget-slug-editor">
  <input id="slug" type="text" class="form-control" style="width: 98%; font-size: 14px">
  <i id="error" class="fa fa-exclamation-triangle is-slug-duplicate"></i>
  <i id="ok" class="fa fa-check-circle is-slug-unique"></i>
  <i id="loading" class="fa fa-spinner fa-spin"></i>
</div>
<script>
(function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={exports:{},id:moduleId,loaded:false};modules[moduleId].call(module.exports,module,module.exports,__webpack_require__);module.loaded=true;return module.exports}__webpack_require__.m=modules;__webpack_require__.c=installedModules;__webpack_require__.p="";return __webpack_require__(0)})([function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _channel=__webpack_require__(1);var _channel2=_interopRequireDefault(_channel);var _fieldLocale=__webpack_require__(3);var _fieldLocale2=_interopRequireDefault(_fieldLocale);var _window=__webpack_require__(5);var _window2=_interopRequireDefault(_window);var _entry=__webpack_require__(6);var _entry2=_interopRequireDefault(_entry);var _space=__webpack_require__(8);var _space2=_interopRequireDefault(_space);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}window.contentfulWidget=setup();exports.default=window.contentfulWidget;function setup(){var readyCallbacks=[];var widget=null;window.addEventListener("message",initializer);return{init:init};function initializer(event){var method=event.data.method;var params=event.data.params;if(method!=="connect"){return}widget=createWidgetAPI(params);window.removeEventListener("message",initializer);readyCallbacks.forEach(function(cb){return cb(widget)})}function init(cb){if(widget){cb(widget)}else{readyCallbacks.push(cb)}}}function createWidgetAPI(_ref){var id=_ref.id;var entry=_ref.entry;var locales=_ref.locales;var field=_ref.field;var fieldInfo=_ref.fieldInfo;var channel=new _channel2.default(id);return{locales:locales,field:new _fieldLocale2.default(channel,field),entry:(0,_entry2.default)(channel,entry,fieldInfo,locales.default),space:(0,_space2.default)(channel),window:(0,_window2.default)(channel)}}},function(module,exports,__webpack_require__){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();Object.defineProperty(exports,"__esModule",{value:true});var _yaku=__webpack_require__(2);var _yaku2=_interopRequireDefault(_yaku);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}else{return Array.from(arr)}}var Channeld=function(){function Channeld(sourceId){var _this=this;_classCallCheck(this,Channeld);this.sourceId=sourceId;this.messageID=0;this.messageHandlers={};this.responseHandlers={};window.addEventListener("message",function(event){_this._handleMessage(event.data)})}_createClass(Channeld,[{key:"call",value:function call(method){var _this2=this;for(var _len=arguments.length,params=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){params[_key-1]=arguments[_key]}var messageID=this._send(method,params);return new _yaku2.default(function(resolve,reject){_this2.responseHandlers[messageID]={resolve:resolve,reject:reject}})}},{key:"send",value:function send(method){for(var _len2=arguments.length,params=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++){params[_key2-1]=arguments[_key2]}this._send(method,params)}},{key:"addHandler",value:function addHandler(method,handler){if(!(method in this.messageHandlers)){this.messageHandlers[method]=[]}this.messageHandlers[method].push(handler)}},{key:"_handleMessage",value:function _handleMessage(message){var _this3=this;if(message.method){(function(){var method=message.method;var params=message.params;var handlers=_this3.messageHandlers[method]||[];handlers.forEach(function(handler){handler.apply(undefined,_toConsumableArray(params))})})()}else{var id=message.id;var result=message.result;var error=message.error;var handler=this.responseHandlers[id];if(!handler){return}if(result){handler.resolve(result)}else if(error){handler.reject(error)}delete this.responseHandlers[id]}}},{key:"_send",value:function _send(method,params){var messageID=this.messageID++;window.parent.postMessage({source:this.sourceId,id:messageID,method:method,params:params},"*");return messageID}}]);return Channeld}();exports.default=Channeld},function(module,exports){(function(global){(function(){"use strict";var $nil,root=typeof global==="object"?global:window,isLongStackTrace=false,$rejected=0,$resolved=1,$pending=2,$promiseTrace="_pt",$settlerTrace="_st",$fromPrevious="From previous event:",$unhandledRejection="unhandledRejection";var Yaku=module.exports=function Promise(executor){var self=this,err;if(isLongStackTrace)self[$promiseTrace]=genTraceInfo();if(executor!==$noop){err=genTryCatcher(executor,self)(genSettler(self,$resolved),genSettler(self,$rejected));if(err===$tryErr)settlePromise(self,$rejected,err.e)}};extendPrototype(Yaku,{then:function then(onFulfilled,onRejected){return addHandler(this,newEmptyYaku(),onFulfilled,onRejected)},"catch":function(onRejected){return this.then($nil,onRejected)},_state:$pending,_pCount:0,_pre:null,_Yaku:1});Yaku.resolve=function resolve(val){return isYaku(val)?val:settleWithX(newEmptyYaku(),val)};Yaku.reject=function reject(reason){return settlePromise(newEmptyYaku(),$rejected,reason)};Yaku.race=function race(iterable){var iter,len,i=0;var p=newEmptyYaku(),item;if(iterable instanceof Array){len=iterable.length;while(i<len){settleWithX(p,iterable[i++]);if(p._state!==$pending)break}}else{iter=genIterator(iterable);while(!(item=iter.next()).done){settleWithX(p,item.value);if(p._state!==$pending)break}}return p};Yaku.all=function all(iterable){var p1=newEmptyYaku(),res=[],item,countDown=0,iter,len;function onRejected(reason){settlePromise(p1,$rejected,reason)}if(iterable instanceof Array){len=iterable.length;while(countDown<len){runAll(countDown,iterable[countDown++],p1,res,onRejected)}}else{iter=genIterator(iterable);while(!(item=iter.next()).done){runAll(countDown++,item.value,p1,res,onRejected)}}onRejected._c=countDown;if(!countDown)settlePromise(p1,$resolved,[]);return p1};function runAll(i,el,p1,res,onRejected){Yaku.resolve(el).then(function(value){res[i]=value;if(!--onRejected._c)settlePromise(p1,$resolved,res)},onRejected)}Yaku.Symbol=root.Symbol||{};Yaku.onUnhandledRejection=function(reason,p){var con=root.console;if(con){var info=genStackInfo(reason,p);con.error($unhandledRejection,info[0],info[1]||"")}};Yaku.enableLongStackTrace=function(){isLongStackTrace=true};Yaku.nextTick=root.process?root.process.nextTick:function(fn){setTimeout(fn)};var $tryCatchFn,$tryCatchThis,$tryErr={e:null},$noop={};function extendPrototype(src,target){for(var k in target){src.prototype[k]=target[k]}return src}function isObject(obj){return typeof obj==="object"}function isFunction(obj){return typeof obj==="function"}function tryCatcher(){try{return $tryCatchFn.apply($tryCatchThis,arguments)}catch(e){$tryErr.e=e;return $tryErr}}function genTryCatcher(fn,self){$tryCatchFn=fn;$tryCatchThis=self;return tryCatcher}function genScheduler(initQueueSize,fn){var fnQueue=Array(initQueueSize),fnQueueLen=0;function flush(){var i=0;while(i<fnQueueLen){fn(fnQueue[i],fnQueue[i+1]);fnQueue[i++]=$nil;fnQueue[i++]=$nil}fnQueueLen=0;if(fnQueue.length>initQueueSize)fnQueue.length=initQueueSize}return function(v,arg){fnQueue[fnQueueLen++]=v;fnQueue[fnQueueLen++]=arg;if(fnQueueLen===2)Yaku.nextTick(flush)}}function genIterator(obj){if(obj){var gen=obj[Yaku.Symbol.iterator];if(isFunction(gen)){return gen.call(obj)}if(isFunction(obj.next)){return obj}}throw genTypeError("invalid_argument")}function genTypeError(msg){return new TypeError(msg)}function genTraceInfo(noTitle){return((new Error).stack||"").replace("Error",noTitle?"":$fromPrevious)}var scheduleHandler=genScheduler(999,function(p1,p2){var x,handler;handler=p1._state?p2._onFulfilled:p2._onRejected;if(handler===$nil){settlePromise(p2,p1._state,p1._value);return}x=genTryCatcher(callHanler)(handler,p1._value);if(x===$tryErr){settlePromise(p2,$rejected,x.e);return}settleWithX(p2,x)});var scheduleUnhandledRejection=genScheduler(9,function(p){if(!hashOnRejected(p)){var process=root.process,onunhandledrejection=root.onunhandledrejection,reason=p._value;if(process&&process.listeners($unhandledRejection).length)process.emit($unhandledRejection,reason,p);else if(onunhandledrejection)onunhandledrejection({promise:p,reason:reason});else Yaku.onUnhandledRejection(reason,p)}});function isYaku(val){return val&&val._Yaku}function newEmptyYaku(){return new Yaku($noop)}function genSettler(self,state){return function(value){if(isLongStackTrace)self[$settlerTrace]=genTraceInfo(true);if(state===$resolved)settleWithX(self,value);else settlePromise(self,state,value)}}function addHandler(p1,p2,onFulfilled,onRejected){if(isFunction(onFulfilled))p2._onFulfilled=onFulfilled;if(isFunction(onRejected))p2._onRejected=onRejected;if(isLongStackTrace)p2._pre=p1;p1[p1._pCount++]=p2;if(p1._state!==$pending)scheduleHandler(p1,p2);return p2}function hashOnRejected(node){if(node._umark)return true;else node._umark=true;var i=0,len=node._pCount,child;while(i<len){child=node[i++];if(child._onRejected||hashOnRejected(child))return true}}function genStackInfo(reason,p){var stackInfo=[],stackStr,i;function trim(str){return str.replace(/^\s+|\s+$/g,"")}function push(trace){return stackInfo.push(trim(trace))}if(isLongStackTrace&&p[$promiseTrace]){if(p[$settlerTrace])push(p[$settlerTrace]);(function iter(node){if(node){iter(node._next);push(node[$promiseTrace]);iter(node._pre)}})(p)}stackStr="\n"+stackInfo.join("\n");function clean(stack,cleanPrev){if(cleanPrev&&(i=stack.indexOf("\n"+$fromPrevious))>0)stack=stack.slice(0,i);return stack.replace(/^.+\/node_modules\/yaku\/.+\n?/gm,"")}return[reason?reason.stack?clean(trim(reason.stack),true):reason:reason,clean(stackStr)]}function callHanler(handler,value){return handler(value)}function settlePromise(p,state,value){var i=0,len=p._pCount,p2,stack;if(p._state===$pending){p._state=state;p._value=value;if(state===$rejected){if(isLongStackTrace&&value&&value.stack){stack=genStackInfo(value,p);value.stack=stack[0]+stack[1]}scheduleUnhandledRejection(p)}while(i<len){p2=p[i++];if(p2._state!==$pending)continue;scheduleHandler(p,p2)}}return p}function settleWithX(p,x){if(x===p&&x){settlePromise(p,$rejected,genTypeError("promise_circular_chain"));return p}if(x!=null&&(isFunction(x)||isObject(x))){var xthen=genTryCatcher(getThen)(x);if(xthen===$tryErr){settlePromise(p,$rejected,xthen.e);return p}if(isFunction(xthen)){if(isLongStackTrace&&isYaku(x))p._next=x;settleXthen(p,x,xthen)}else settlePromise(p,$resolved,x)}else settlePromise(p,$resolved,x);return p}function getThen(x){return x.then}function settleXthen(p,x,xthen){var err=genTryCatcher(xthen,x)(function(y){if(x){x=null;settleWithX(p,y)}},function(r){if(x){x=null;settlePromise(p,$rejected,r)}});if(err===$tryErr&&x){settlePromise(p,$rejected,err.e);x=null}}})()}).call(exports,function(){return this}())},function(module,exports,__webpack_require__){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();Object.defineProperty(exports,"__esModule",{value:true});var _signal=__webpack_require__(4);var _signal2=_interopRequireDefault(_signal);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var FieldLocale=function(){function FieldLocale(channel,_ref){var _this=this;_classCallCheck(this,FieldLocale);var id=_ref.id;var locale=_ref.locale;var value=_ref.value;this.id=id;this.locale=locale;this._value=value;this._valueSignal=new _signal2.default;this._channel=channel;channel.addHandler("valueChanged",function(id,locale,value){if(id===_this.id&&locale===_this.locale){_this._value=value;_this._valueSignal.dispatch(value)}})}_createClass(FieldLocale,[{key:"getValue",value:function getValue(){return this._value}},{key:"setValue",value:function setValue(value){return this._channel.call("setValue",this.id,this.locale,value)}},{key:"onValueChanged",value:function onValueChanged(handler){return this._valueSignal.attach(handler)}}]);return FieldLocale}();exports.default=FieldLocale},function(module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();Object.defineProperty(exports,"__esModule",{value:true});function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Signal=function(){function Signal(){_classCallCheck(this,Signal);this._id=0;this._listeners={}}_createClass(Signal,[{key:"dispatch",value:function dispatch(){for(var key in this._listeners){var _listeners;(_listeners=this._listeners)[key].apply(_listeners,arguments)}}},{key:"attach",value:function attach(listener){var id=this._id++;this._listeners[id]=listener;var self=this;return function removeListener(){delete self._listeners[id]}}}]);return Signal}();exports.default=Signal},function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=createWindow;function createWindow(channel){var observer=new MutationObserver(function(){return updateHeight()});var oldHeight=null;return{startAutoResizer:startAutoResizer,stopAutoResizer:stopAutoResizer,updateHeight:updateHeight};function startAutoResizer(){observer.observe(window.document.body,{attributes:true,childList:true,subtree:true,characterData:true})}function stopAutoResizer(){observer.disconnect()}function updateHeight(height){if(height==null){var offsetHeight=window.document.body.offsetHeight;height=offsetHeight}if(height!==oldHeight){channel.send("setHeight",height)}}}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=createEntry;var _signal=__webpack_require__(4);var _signal2=_interopRequireDefault(_signal);var _field=__webpack_require__(7);var _field2=_interopRequireDefault(_field);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function createEntry(channel,entryData,fieldInfo,defaultLocale){var sys=entryData.sys;var sysChanged=new _signal2.default;channel.addHandler("sysChanged",function(_sys){sys=_sys;sysChanged.dispatch(sys)});var entry={fields:{},getSys:function getSys(){return sys},onSysChanged:function onSysChanged(handler){return sysChanged.attach(handler)}};fieldInfo.forEach(function(info){entry.fields[info.id]=new _field2.default(channel,info,defaultLocale)});return entry}},function(module,exports,__webpack_require__){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();Object.defineProperty(exports,"__esModule",{value:true});var _signal=__webpack_require__(4);var _signal2=_interopRequireDefault(_signal);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Field=function(){function Field(channel,info,defaultLocale){var _this=this;_classCallCheck(this,Field);this.id=info.id;this._locales=info.locales;this._defaultLocale=defaultLocale;this._valueSignals={};this._values=info.values;this._channel=channel;this._locales.forEach(function(locale){_this._valueSignals[locale]=new _signal2.default});channel.addHandler("valueChanged",function(id,locale,value){if(id===_this.id){console.log(id,locale);_this._values[locale]=value;if(locale in _this._valueSignals)_this._valueSignals[locale].dispatch(value)}})}_createClass(Field,[{key:"getValue",value:function getValue(locale){locale=locale||this._defaultLocale;return this._values[locale]}},{key:"setValue",value:function setValue(value,locale){locale=locale||this._defaultLocale;this._values[locale]=value;return this._channel.call("setValue",this.id,locale,value)}},{key:"removeValue",value:function removeValue(locale){this.setValue(locale)}},{key:"onValueChanged",value:function onValueChanged(locale,handler){if(!handler){handler=locale;locale=this._defaultLocale}return this._valueSignals[locale].attach(handler)}}]);return Field}();exports.default=Field},function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=createSpace;var spaceMethods=["getContentType","getContentTypes","createContentType","updateContentType","deleteContentType","getEntries"];function createSpace(channel){var space={};spaceMethods.forEach(function(methodName){space[methodName]=function(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key]}return channel.call("callSpaceMethod",methodName,args)}});return space}}]);</script>
<script>
var input=document.getElementById("slug");var contentTypes=["slug","slug2"];window.contentfulWidget.init(function(api){var statusElements={error:document.getElementById("error"),ok:document.getElementById("ok"),loading:document.getElementById("loading")};api.window.updateHeight();var slugField=api.field;var titleField=api.entry.fields.title;titleField.onValueChanged(function(title){setSlug(window.getSlug(title||""))});var debouncedUpdateStatus=_.debounce(updateStatus,500);updateStatus(slugField.getValue());function setSlug(slug){input.value=slug;slugField.setValue(slug);setStatus("loading");debouncedUpdateStatus(slug)}function setStatus(status){_.each(statusElements,function(el,name){if(name===status){el.style.display="inline"}else{el.style.display="none"}})}function updateStatus(slug){console.log("update");getDuplicates(slug).then(function(hasDuplicates){if(hasDuplicates){setStatus("error")}else{setStatus("ok")}})}function getDuplicates(slug){if(!slug){return Promise.resolve(false)}return Promise.all(contentTypes.map(function(ct){return query(ct,slug)})).then(function(values){return _.any(values)})}function query(ct,slug){var query={};query["content_type"]=ct;query["fields."+api.field.id]=slug;query["sys.id[ne]"]=api.entry.getSys().id;query["sys.publishedAt[exists]"]=true;return api.space.getEntries(query).then(function(result){return result.length>0})}});</script>
